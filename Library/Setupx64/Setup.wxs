<?xml version="1.0" encoding="UTF-8"?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension"
     xmlns:sql="http://schemas.microsoft.com/wix/SqlExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

  <Fragment>

    <!-- This custom action prevents users from installing if a newer version of this product is already -->
    <!-- installed on the system. This is a part of Windows Installer major upgrade functionality.       -->
    <CustomAction Id="CA_BlockOlderVersionInstall"
                      Error="!(loc.LaunchCondition_LaterVersion)" />

    <!-- This custom action prevents users from installing this product on unsupported operating system  -->
    <!-- versions. The conditions that are checked for operating system version are defined below.       -->
    <CustomAction Id="CA_ErrWrongWindowsVersion"
                      Error="!(loc.LaunchCondition_WrongOSVersion)" />

    <Condition Message="This application requires .NET Framework 3.5.  Please install .NET Framework then run this installer again.">
      <![CDATA[Installed OR NETFRAMEWORK35]]>
    </Condition>
    <!-- This condition adds an item to the LaunchCondition table of the MSI to block a user from        -->
    <!-- installing this product unless they have administrative privileges on the system.               -->
    <Condition Message="!(loc.LaunchCondition_AdminPrivs)">
      <![CDATA[Privileged]]>
    </Condition>

    <!-- This is a list of directories that are used by this product as installation locations or custom -->
    <!-- action file search locations.                                                                   -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="WindowsFolder" Name="WINDOWS">
        <Directory Id="EhomeFolder" Name="eHome"/>
      </Directory>
      <Directory Id="ProgramFiles64Folder" Name="Program Files">
        <Directory Id="APPLICATIONROOTDIRECTORY" Name="OpenMediaLibrary">
          <Component Id="Library.dll" Guid="6bee7ed8-c866-470b-9656-8b0320c923b5" Win64="yes" DiskId="1">
            <File Name="Library.dll"
                  KeyPath="yes" Source="..\..\Library\bin\$(var.BuildType)\Library.dll"
                  Checksum="yes" Vital="yes" Assembly=".net"/>
          </Component>
          <Component Id="OMLEngine.dll" Guid="fa02e91a-33fd-45e9-b189-a2cf15d3ea90" Win64="yes" DiskId="1">
            <File Name="OMLEngine.dll"
                  KeyPath="yes" Source="..\..\OMLEngine\bin\$(var.BuildType)\OMLEngine.dll"
                  Checksum="yes" Vital="yes" Assembly=".net"/>
          </Component>
          <Component Id="dssnap.dll" Guid="5fd9888f-4eb4-4da1-bc2a-f82d3c5e4e53" Win64="yes" DiskId="1">
            <File Name="dssnap.dll"
                  KeyPath="yes" Source="..\..\OMLEngine\bin\$(var.BuildType)\dssnap.dll"
                  Checksum="yes" Vital="yes" Assembly=".net"/>
          </Component>
          <Component Id="OMLFileWatcher.dll" Guid="7ea6b674-1ad6-417a-a184-7f89aa8b1578" Win64="yes" DiskId="1">
            <File Name="OMLFileWatcher.dll"
                  KeyPath="yes" Source="..\..\OMLFileWatcher\bin\$(var.BuildType)\OMLFileWatcher.dll"
                  Checksum="yes" Vital="yes" Assembly=".net"/>
          </Component>
          <Component Id="OMLTranscoder.dll" Guid="af99c403-9114-4809-a9af-ba8038d47ea7" Win64="yes" DiskId="1">
            <File Name="OMLTranscoder.dll"
                  KeyPath="yes" Source="..\..\OMLTranscoder\bin\$(var.BuildType)\OMLTranscoder.dll"
                  Checksum="yes" Vital="yes" Assembly=".net"/>
          </Component>
          <Component Id="FileDownloader.dll" Guid="F52BAB24-FE4F-43D6-9259-D56E2EFEC5DC" Win64="yes" DiskId="1">
            <File Name="FileDownloader.dll"
                  KeyPath="yes" Source="..\..\FileDownloader\bin\$(var.BuildType)\FileDownloader.dll"
                  Checksum="yes" Vital="yes" Assembly=".net"/>
          </Component>
          <Component Id="Registration.xml" Guid="68b08279-69c0-42fb-b087-30a20ee12608" Win64="yes" DiskId="1">
            <File Name="Registration.xml"
                  Source="..\..\Library\Registration.xml" Checksum="no" />
          </Component>
          <Component Id="Application.png" Guid="34c83bcd-a522-4103-8bac-ad159113d313" Win64="yes" DiskId="1">
            <File Name="Application.png"
                  Source="..\..\Library\Images\Application.png" Checksum="no" />
            <File Name="Application2.png"
                  Source="..\..\Library\Images\Application2.png" Checksum="no" />
            <File Name="Settings.png"
                  Source="..\..\Library\Images\Settings.png" Checksum="no" />
          </Component>

          <!--<Component Id="ComponentFactory.Krypton.Toolkit.DLL" Guid="ACDECE2C-B066-415e-AD42-0B63D341300F" Win64="yes" DiskId="1">
                        <File Name="ComponentFactory.Krypton.Toolkit.DLL"
                              Source="..\..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\ComponentFactory.Krypton.Toolkit.DLL" Checksum="no" />
                    </Component>-->
          <Component Id="DevExpress.Data.v8.2.dll" Guid="5268f9d7-2529-4af0-b5fb-6b94079a7f74" Win64="yes" DiskId="1">
            <File Name="DevExpress.Data.v8.2.dll"
                  Source="..\..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\DevExpress.Data.v8.2.dll" Checksum="no" />
          </Component>
          <Component Id="DevExpress.Utils.v8.2.dll" Guid="419c9895-3e28-442c-af94-d77f9e4487b4" Win64="yes" DiskId="1">
            <File Name="DevExpress.Utils.v8.2.dll"
                  Source="..\..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\DevExpress.Utils.v8.2.dll" Checksum="no" />
          </Component>
          <Component Id="DevExpress.XtraEditors.v8.2.dll" Guid="cd530611-c23a-4a31-aa6e-ac8926845707" Win64="yes" DiskId="1">
            <File Name="DevExpress.XtraEditors.v8.2.dll"
                  Source="..\..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\DevExpress.XtraEditors.v8.2.dll" Checksum="no" />
          </Component>
          <Component Id="DevExpress.XtraNavBar.v8.2.dll" Guid="cd530611-c23a-4a31-aa6f-ac8926845707" Win64="yes" DiskId="1">
            <File Name="DevExpress.XtraNavBar.v8.2.dll"
                  Source="..\..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\DevExpress.XtraNavBar.v8.2.dll" Checksum="no" />
          </Component>
          <Component Id="DevExpress.Data.v8.2.xml" Guid="25af85cb-dc9d-46df-b022-f8a3df4f71fb" Win64="yes" DiskId="1">
            <File Name="DevExpress.Data.v8.2.xml"
                  Source="..\..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\DevExpress.Data.v8.2.xml" Checksum="no" />
          </Component>
          <Component Id="DevExpress.Utils.v8.2.xml" Guid="ac15ad59-c236-4a0b-9cb9-a009684582b7" Win64="yes" DiskId="1">
            <File Name="DevExpress.Utils.v8.2.xml"
                  Source="..\..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\DevExpress.Utils.v8.2.xml" Checksum="no" />
          </Component>
          <Component Id="DevExpress.XtraEditors.v8.2.xml" Guid="365ba1f3-7823-4ff7-ac1c-cb040d2b852e" Win64="yes" DiskId="1">
            <File Name="DevExpress.XtraEditors.v8.2.xml"
                  Source="..\..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\DevExpress.XtraEditors.v8.2.xml" Checksum="no" />
          </Component>
          <Component Id="DevExpress.XtraNavBar.v8.2.xml" Guid="365ba1f3-7823-4ff8-ac1c-cb040d2b852e" Win64="yes" DiskId="1">
            <File Name="DevExpress.XtraNavBar.v8.2.xml"
                  Source="..\..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\DevExpress.XtraNavBar.v8.2.xml" Checksum="no" />
          </Component>
          <Component Id="StSana.dll" Guid="A6906C01-D2A4-432d-89B1-28C11EA89E18"  Win64="yes" DiskId="1">
            <File Name="StSana.dll"
                  Source="..\..\OMLDatabaseEditor2\StSana.dll" Checksum="no" />
          </Component>
          <Component Id="OMLDatabaseEditor.exe" Guid="4226fe89-8797-44ed-b463-6fda1be5c918" Win64="yes" DiskId="1">
            <File Name="OMLDatabaseEditor.exe"
                  Source="..\..\OMLDatabaseEditor2\bin\$(var.BuildType)\OMLDatabaseEditor.exe" Checksum="no" />
          </Component>
          <Component Id="OMLImporter.exe" Guid="5405ac5c-69ba-49c0-8854-bb766ffe44bb" Win64="yes" DiskId="1">
            <File Name="OMLImporter.exe"
                  Source="..\..\OMLImporter\bin\$(var.BuildType)\OMLImporter.exe" Checksum="no" />
          </Component>
          <Component Id="MEncoder.exe" Guid="1a3587c9-7219-4298-9351-c1ed480e430f" Win64="yes" DiskId="1">
            <File Name="MEncoder.exe"
                  Source="..\..\OMLTranscoder\mencoder-1.0rc2-4.2.1.exe" Checksum="no" />
          </Component>
          
          <Component Id="MediaInfo.dll" Guid="BCDD1285-37EA-4086-838A-82BE908F074F" Win64="yes" DiskId="1">
            <File Name="MediaInfo.dll"
                              Source="..\..\OMLEngine\MediaInfox64.dll" Checksum="no" />
          </Component>
          <Component Id="PostInstallerWizard.exe" Guid="2C61F163-CE14-4fb3-9974-0792E2C5B900" Win64="yes" DiskId="1">
            <File Name="PostInstallerWizard.exe"
                              Source="..\..\PostInstallerWizard\bin\$(var.BuildType)\PostInstallerWizard.exe" Checksum="no" />
          </Component>
          
          <Component Id="TranscoderTester.exe" Guid="2F7D11B3-70BD-4f2d-9EC1-730D28042BBF" DiskId="1" Win64="yes">
            <File Name="TranscoderTester.exe"
                Source="..\..\TranscoderTester\bin\$(var.BuildType)\TranscoderTester.exe" Checksum="no" />
          </Component>
          
          <Component Id="Maximizer.exe" Guid="e94299e1-62cd-4068-8861-052c8c7bec6c" Win64="yes" DiskId="1">
            <File Name="Maximizer.exe"
                  Source="..\..\Maximizer\bin\$(var.BuildType)\Maximizer.exe" Checksum="no" />
          </Component>

          <Component Id="OMLEngineService.exe" Guid="12988468-3dcc-496a-b0b3-6982ffde25b9" DiskId="1" Win64="yes">
            <File Name="OMLEngineService.exe" KeyPath="yes"
                  Source="..\..\OMLEngineService\bin\$(var.BuildType)\OMLEngineService.exe" Checksum="yes"/>
            <File Name="OMLEngineService.exe.config"
                  Source="..\..\OMLEngineService\bin\$(var.BuildType)\OMLEngineService.exe.config" Checksum="no"/>
            <ServiceControl Id="OMLEngineServiceControl" Name="OMLEngineService" Stop="both" Remove="uninstall"/>
            <ServiceInstall Id="OMLEngineService" Name="OMLEngineService" DisplayName="OMLEngineService"
                            Type="ownProcess" Interactive="no" Start="demand" Vital="yes"
                            ErrorControl="normal">
            <util:PermissionEx User="Users" ServiceQueryConfig="yes" ServiceChangeConfig="yes" ServiceQueryStatus="yes"
                               ServiceEnumerateDependents="yes" ServiceStart="yes" ServiceStop="yes" ServicePauseContinue="yes"
                               ServiceInterrogate="yes" ServiceUserDefinedControl="yes"/>
            <util:ServiceConfig ServiceName="OMLEngineService" FirstFailureActionType="restart" SecondFailureActionType="restart"
                                ThirdFailureActionType="restart" ResetPeriodInDays="7" RestartServiceDelayInSeconds="60"/>
            </ServiceInstall>
            <!--<ServiceControl Id="OMLEngineServiceControl" Name="OMLEngineService"
                                        Start="install" Stop="both" Wait="yes" Remove="uninstall"/>-->
          </Component>

          <Component Id="OMLFWService.exe" Guid="8f57190c-0489-40b4-9c46-5e9b09ec0dec" DiskId="1" Win64="yes">
            <File Name="OMLFWService.exe"
                  Source="..\..\OMLFWService\bin\$(var.BuildType)\OMLFWService.exe" Checksum="yes"/>
            <ServiceControl Id="OMLFWServiceControl" Name="OMLFWService" Stop="both" Remove="uninstall"/>
            <ServiceInstall Id="OMLFWService" Name="OMLFWService" DisplayName="OMLFWService"
                            Type="ownProcess" Interactive="no" Start="demand" Vital="yes"
                            ErrorControl="normal">
            <util:PermissionEx User="Users" ServiceQueryConfig="yes" ServiceChangeConfig="yes" ServiceQueryStatus="yes"
                               ServiceEnumerateDependents="yes" ServiceStart="yes" ServiceStop="yes" ServicePauseContinue="yes"
                               ServiceInterrogate="yes" ServiceUserDefinedControl="yes"/>
            <util:ServiceConfig ServiceName="OMLFWService" FirstFailureActionType="restart" SecondFailureActionType="restart"
                                ThirdFailureActionType="restart" ResetPeriodInDays="7" RestartServiceDelayInSeconds="60"/>
            </ServiceInstall>
            <!--<ServiceControl Id="OMLFWServiceControl" Name="OMLFWService"
                                        Start="install" Stop="both" Wait="yes" Remove="uninstall"/>-->
          </Component>

          <Directory Id="SQLDBSCRIPTS" Name="SQLInstaller">
            <Component Id="TitleDatabase.sql" Guid="51867C0A-0FB6-4f4a-AEF6-1C6FEBB47143" Win64="yes" DiskId="1">
              <File Name="Title Database.sql"
                                Source="..\..\SQL Scripts\Title Database.sql" Checksum="no" />
            </Component>
            <Component Id="TitleDatabaseUpgrade1.1.sql" Guid="81162A55-6145-419a-93A0-8AA5855542FC" Win64="yes" DiskId="1">
              <File Name="Title Database - Upgrade 1.1.sql"
                                Source="..\..\SQL Scripts\Title Database - Upgrade 1.1.sql" Checksum="no" />
            </Component>
            <Component Id="TitleDatabaseUpgrade1.2.sql" Guid="0E88D597-EA38-4940-B5AA-08B4753EB5D7" Win64="yes" DiskId="1">
              <File Name="Title Database - Upgrade 1.2.sql"
                                Source="..\..\SQL Scripts\Title Database - Upgrade 1.2.sql" Checksum="no" />
            </Component>
            <Component Id="SQLConfigNoTools_x64.ini" Guid="F35FE429-19F9-4d7f-ABDD-CD2F0F01F170" Win64="yes" DiskId="1">
              <File Name="SQLConfigNoTools_x64.ini"
                                Source="..\..\SQL Scripts\SQLConfigNoTools_x64.ini" Checksum="no" />
            </Component>
          </Directory>
          
          <Directory Id ="HELPDIRECTORY" Name="Help">
            <Component Id="Open_Media_Library_User_Manual.pdf" Guid="699C7762-E52E-4761-81C3-52B01231A2D2" Win64="yes" DiskId="1">
              <File Name="Open_Media_Library_User_Manual.pdf" KeyPath="no"
                    Source="..\..\Documentation\Open_Media_Library_User_Manual.pdf" Checksum="no" Vital="yes"/>
            </Component>
          </Directory>
          <Directory Id="PLUGINSDIRECTORY" Name="Plugins">
            <Component Id="DVDProfilerPlugin.dll" Guid="b7f12ef4-e500-4d0e-bfbe-d77eae64176c" Win64="yes" DiskId="1">
              <File Name="DVDProfilerPlugin.dll"
                    KeyPath="yes" Source="..\..\DVDProfilerPlugin\bin\$(var.BuildType)\DVDProfilerPlugin.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="DVRMSPlugin.dll" Guid="ec74a168-53ae-4bef-a72d-3ff093bb8b0f" Win64="yes" DiskId="1">
              <File Name="DVRMSPlugin.dll"
                    KeyPath="yes" Source="..\..\DVRMSPlugin\bin\$(var.BuildType)\DVRMSPlugin.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="MovieCollectorz.dll" Guid="b3a7750c-5474-4bdf-9926-64e13ed92a97" Win64="yes" DiskId="1">
              <File Name="MovieCollectorz.dll"
                    KeyPath="yes" Source="..\..\MovieCollectorz\bin\$(var.BuildType)\MovieCollectorz.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="MyMoviesPlugin.dll" Guid="4102ad78-c010-4367-8454-7317713ccfe6" Win64="yes" DiskId="1">
              <File Name="MyMoviesPlugin.dll"
                    KeyPath="yes" Source="..\..\MyMoviesPlugin\bin\$(var.BuildType)\MyMoviesPlugin.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="MyMoviesToOML.xsl" Guid="a449cc9c-7e60-49bf-982b-ce389fbe7d40" Win64="yes" DiskId="1">
              <File Name="MyMoviesToOML.xsl"
                    KeyPath="yes" Source="..\..\MyMoviesPlugin\MyMoviesToOML.xsl"
                    Vital="yes"/>
            </Component>
            <Component Id="VMCDVDLibraryPlugin.dll" Guid="d8028d8c-a048-46b2-9c27-c64f07c8ab8d" Win64="yes" DiskId="1">
              <File Name="VMCDVDLibraryPlugin.dll"
                    KeyPath="yes" Source="..\..\VMCDVDLibraryPlugin\bin\$(var.BuildType)\VMCDVDLibraryPlugin.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="OMLXMLImporter.dll" Guid="5be2002c-ef0d-4358-93ef-5c495492ab0d" Win64="yes" DiskId="1">
              <File Name="OMLXMLImporter.dll"
                    KeyPath="yes" Source="..\..\OMLXMLImporter\bin\$(var.BuildType)\OMLXMLImporter.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="AmazonMetadata.dll" Guid="1B066A38-E25A-4334-BD48-582CD6518019" Win64="yes" DiskId="1">
              <File Name="AmazonMetadata.dll"
                    KeyPath="yes" Source="..\..\AmazonMetadata2\bin\$(var.BuildType)\AmazonMetadata.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="TheMovieDbMetadata.dll" Guid="46534b9a-16b6-4c74-ab87-03b89be3b160" Win64="yes" DiskId="1">
              <File Name="TheMovieDbMetadata.dll"
                    KeyPath="yes" Source="..\..\TheMovieDbMetadata\bin\$(var.BuildType)\TheMovieDbMetadata.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="NetFlixMetadata.dll" Guid="73213057-08D2-4262-A8F2-4A4FC7BE6F62" Win64="yes" DiskId="1">
              <File Name="NetFlixMetadata.dll"
                    KeyPath="yes" Source="..\..\NetFlixMetadata\bin\$(var.BuildType)\NetFlixMetadata.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="DVDProfilerMetaData.dll" Guid="830DF3C8-507C-49f2-8153-CBE2949945A5" Win64="yes" DiskId="1">
              <File Name="DVDProfilerMetaData.dll"
                    KeyPath="yes" Source="..\..\DVDProfilerMetaData\bin\$(var.BuildType)\DVDProfilerMetaData.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="TVDBMetadata.dll" Guid="3A38B541-1AB0-4906-B8F5-E05F3537BC46" Win64="yes" DiskId="1">
              <File Name="TVDBMetadata.dll"
                    KeyPath="yes" Source="..\..\TVDBMetadata\bin\$(var.BuildType)\TVDBMetadata.dll"
                    Checksum="yes" Vital="yes"/>
            </Component>
            <Component Id="OMLSDK.dll" Guid="26097a63-fc55-41d2-a8d5-432809de99fc" Win64="yes" DiskId="1">
              <File Name="OMLSDK.dll"
                    KeyPath="yes" Source="..\..\OMLSDK\bin\$(var.BuildType)\OMLSDK.dll"
                    Checksum="yes" Vital="yes" Assembly=".net"/>
            </Component>
            <!--<Component Id="OMLGetDVDInfo.dll" Guid="d69b2e44-0e10-4081-9628-4db9a9ba7c0c" Win64="yes" DiskId="1">
                            <File Name="OMLGetDVDInfo.dll"
                                  KeyPath="yes" Source="..\..\OMLGetDVDInfo\bin\$(var.BuildType)\OMLGetDVDInfo.dll"
                                  Checksum="yes" Vital="yes" Assembly=".net"/>
                        </Component>-->
          </Directory>
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="OpenMediaLibrary">
          <Component Id="DatabaseEditorShortcut" Win64="yes" Guid="">
            <Shortcut Id="DatabaseEditorStartMenuShortcut"
                      Name="OML Database Editor"
                      Description="My Application Description"
                      Target="[APPLICATIONROOTDIRECTORY]OMLDatabaseEditor.exe"
                      Icon="icon.ico"
                      WorkingDirectory="APPLICATIONROOTDIRECTORY"/>
            <RemoveFolder Id="ApplicationProgramsFolder" On="uninstall"/>
            <RegistryValue Root="HKCU" Key="Software\OpenMediaLibrary\DatabaseEditorShortcut" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
          </Component>
          <Component Id="ImporterShortcut" Win64="yes" Guid="">
            <Shortcut Id="ImporterStartMenuShortcut"
                      Name="Commandline Database Editor"
                      Description="My Application Description"
                      Target="[APPLICATIONROOTDIRECTORY]OMLImporter.exe"
                      WorkingDirectory="APPLICATIONROOTDIRECTORY"/>
            <RegistryValue Root="HKCU" Key="Software\OpenMediaLibrary\ImporterShortcut" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
          </Component>
          <Component Id="UserManualShortcut" Win64="yes" Guid="">
            <Shortcut Id="UserManualStartMenuShortcut"
                      Name="User Manual"
                      Description="OML User Manual"
                      Target="[HELPDIRECTORY]Open_Media_Library_User_Manual.pdf"
                      WorkingDirectory="HELPDIRECTORY"/>
            <RegistryValue Root="HKCU" Key="Software\OpenMediaLibrary\UserManualShortcut" Name="installed" Type="integer" Value="1" KeyPath="yes"/>
          </Component>
        </Directory>
      </Directory>
    </Directory>
    <DirectoryRef Id="TARGETDIR">
      <Component Id="registryUI" Guid="FDDE2AF7-995E-4b84-B8B7-2E150E7C7101" DiskId="1" KeyPath="yes" Win64="yes">
        <RegistryKey Id="registry0" Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\Media Center\Start Menu\Applications\{3f0850a7-0fd7-4cbf-b8dc-c7f7ea31534e}" Action="create">
          <RegistryValue Id="reg1" Type="string" Name="Title" Value="Open Media Library" Action="write"/>
          <RegistryValue Id="reg2" Type="string" Name="Category" Value="OML\Open Media Library" Action="write"/>
          <RegistryValue Id="reg3" Type="string" Name="OnStartMenu" Value="True" Action="write"/>
          <RegistryValue Id="reg4" Type="integer" Name="TimeStamp" Value="214505905" Action="write"/>
        </RegistryKey>
        <RegistryKey Id="registry1" Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\Media Center\Extensibility\Categories\OML\Open Media Library" Action="create"/>
        <RegistryKey Id="registry2" Root="HKLM" Key="Software\Microsoft\Windows\CurrentVersion\Media Center\Extensibility\Entry Points\{1044a023-44cc-401c-a5df-4f58601f1f57}" Action="create">
          <RegistryValue Id="reg5" Type="expandable" Name="AddIn" Value="Library.MyAddIn, Library,Culture=Neutral,Version=4.0.0.0,PublicKeyToken=74d3b407d6cf16f1" Action="write"/>
          <RegistryValue Id="reg6" Type="string" Name="AppId" Value="{3f0850a7-0fd7-4cbf-b8dc-c7f7ea31534e}" Action="write"/>
          <RegistryValue Id="reg7" Type="expandable" Name="Context" Value="Menu" Action="write"/>
          <RegistryValue Id="reg8" Type="expandable" Name="Description" Value="Open Media Library" Action="write"/>
          <RegistryValue Id="reg9" Type="expandable" Name="ImageUrl" Value="C:\Program Files\Open Media Library\Application.png" Action="write"/>
          <RegistryValue Id="reg10" Type="integer" Name="TimeStamp" Value="214505905" Action="write"/>
          <RegistryValue Id="reg11" Type="string" Name="Title" Value="Open Media Library" Action="write"/>
        </RegistryKey>
        <RemoveRegistryKey Action="removeOnInstall" Id="deleteOldKey" Root="HKCU" Key="Software\Microsoft\Windows\CurrentVersion\Media Center\Extensibility\Categories\Services\Movies\{543d0438-b10d-43d8-a20d-f0c96db4e6bd}" />
        <RemoveRegistryKey Action="removeOnInstall" Id="deleteOldKey1" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Media Center\Extensibility\Applications\{ad208fce-2431-47d6-abed-1974a2a0555f}" />
        <RemoveRegistryKey Action="removeOnInstall" Id="deleteOldKey2" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Media Center\Extensibility\Categories\OML\Media Library" />
      </Component>
      <Component Id="registryFWS" Guid="1A746A98-A8D4-4e5e-B41F-5E6D6B8B5DFD" DiskId="1" Win64="yes">
        <RegistryKey Id="registryFWS0" Root="HKCU" Key="Software\OpenMediaLibrary" Action="createAndRemoveOnUninstall">
          <RegistryValue Id="registryFWS1" Type="integer" Name="logging" Value="1"/>
          <RegistryValue Id="registryFWS2" Type="multiString" Name="Watches" Value="c:\\users\\public\\recorded tv;*.*" />
        </RegistryKey>
      </Component>
    </DirectoryRef>

    <!-- This is a list of all components installed as a part of this product. A component is the        -->
    <!-- smallest atomic unit of installation in Windows Installer. Each component must have a unique    -->
    <!-- GUID. In general, it is recommended that each file be installed by a separate component in      -->
    <!-- order to avoid reference counting problems and make future servicing of this product easier.    -->
    <!-- Each component is listed as a child of the DirectoryRef that represents the directory that      -->
    <!-- the file it contains will install to.                                                           -->
    <Icon Id="icon.ico" SourceFile="..\..\Library\Resources\Application.ico"/>
    <!-- This is a list of features that are installed as a part of this product. In this case, there is -->
    <!-- only one feature. Each feature contains a list of components that it will install. Features can -->
    <!-- can be displayed and allow user selection in setup UI if desired.  -->

    <ComponentGroup Id="CommonComponents">
      <ComponentRef Id="PostInstallerWizard.exe"/>

      <ComponentRef Id="Application.png" />

      <!-- Required OML Libraries-->
      <ComponentRef Id="OMLEngine.dll" />
      <ComponentRef Id="OMLSDK.dll" />
      <ComponentRef Id="StSana.dll"/>
      <ComponentRef Id="MediaInfo.dll"/>
      <ComponentRef Id="Maximizer.exe"/>
      <ComponentRef Id="OMLEngineService.exe"/>

      <!-- File Watcher-->
      <ComponentRef Id="OMLFWService.exe"/>
      <ComponentRef Id="OMLFileWatcher.dll"/>
      <ComponentRef Id="registryFWS"/>

      <!-- Database scripts-->
      <ComponentRef Id="TitleDatabase.sql"/>
      <ComponentRef Id="TitleDatabaseUpgrade1.1.sql"/>
      <ComponentRef Id="TitleDatabaseUpgrade1.2.sql"/>
      <ComponentRef Id="SQLConfigNoTools_x64.ini"/>
    </ComponentGroup>

    <ComponentGroup Id="ClientGroupUI">
      <!-- Media Center plugin components-->
      <ComponentRef Id="Library.dll" />
      <ComponentRef Id="dssnap.dll" />
      <ComponentRef Id="OMLTranscoder.dll"/>
      <ComponentRef Id="Registration.xml" />
      <ComponentRef Id="MEncoder.exe"/>
      <ComponentRef Id="FileDownloader.dll"/>

      <!-- UI Registry Keys -->
      <ComponentRef Id="registryUI"/>
    </ComponentGroup>

    <ComponentGroup Id="ClientGroupEditor">
      <!-- Editor components -->
      <ComponentRef Id="DevExpress.Data.v8.2.dll"/>
      <ComponentRef Id="DevExpress.Utils.v8.2.dll"/>
      <ComponentRef Id="DevExpress.XtraEditors.v8.2.dll"/>
      <ComponentRef Id="DevExpress.XtraNavBar.v8.2.dll"/>
      <ComponentRef Id="DevExpress.Data.v8.2.xml"/>
      <ComponentRef Id="DevExpress.Utils.v8.2.xml"/>
      <ComponentRef Id="DevExpress.XtraEditors.v8.2.xml"/>
      <ComponentRef Id="DevExpress.XtraNavBar.v8.2.xml"/>
      <ComponentRef Id="OMLDatabaseEditor.exe" />
      <ComponentRef Id="TranscoderTester.exe"/>

      <!-- Importer Plugins -->
      <ComponentRef Id="OMLImporter.exe" />
      <ComponentRef Id="DVDProfilerPlugin.dll" />
      <ComponentRef Id="DVRMSPlugin.dll" />
      <ComponentRef Id="MovieCollectorz.dll" />
      <ComponentRef Id="MyMoviesPlugin.dll" />
      <ComponentRef Id="MyMoviesToOML.xsl" />
      <ComponentRef Id="OMLXMLImporter.dll" />

      <!-- Metadata Plugins -->
      <ComponentRef Id="VMCDVDLibraryPlugin.dll" />
      <ComponentRef Id="AmazonMetadata.dll" />
      <ComponentRef Id="TheMovieDbMetadata.dll" />
      <ComponentRef Id="NetFlixMetadata.dll"/>
      <ComponentRef Id="DVDProfilerMetaData.dll"/>
      <ComponentRef Id="TVDBMetadata.dll"/>


      <!-- Start Menu Shortcuts -->
      <ComponentRef Id="DatabaseEditorShortcut" />
      <ComponentRef Id="ImporterShortcut" />

    </ComponentGroup>

    <ComponentGroup Id="UserGuide">
      <ComponentRef Id="UserManualShortcut" />
      <ComponentRef Id="Open_Media_Library_User_Manual.pdf"/>
    </ComponentGroup>


    <FeatureGroup Id="CLIENTFEATURES">
      <Feature Id="CLIENTFEATUREUI" Title="OML Media Center Plugin" Level="1" AllowAdvertise="no" Description="Install the Media Center Plugin">
        <Condition Level="0"><![CDATA[NOT MCEINSTALLVERSION >= "5.0" OR NOT REGISTERMCEAPP]]></Condition>
        <ComponentGroupRef Id="ClientGroupUI"/>
      </Feature>
      <Feature Id="CLIENTFEATUREEDITOR" Title="OML Database Editor" Level="1" AllowAdvertise="no" Description="Install the Database Editor">
        <ComponentGroupRef Id="ClientGroupEditor"/>
      </Feature>
    </FeatureGroup>




    <!-- The media table defines the location that the MSI will look to find source files during         -->
    <!-- installation or repair scenarios. In this case, the source files are in a cab file that will be -->
    <!-- embedded directly into the MSI at build time.                                                   -->
    <Media Id="1" Cabinet="OpenMediaLibrary.cab" EmbedCab="yes" />

    <!-- These custom actions are used to register the application with Media Center using the utility   -->
    <!-- RegisterMceApp.exe that is installed as a part of the Windows Media Center feature. Each custom -->
    <!-- action is defined as a pair in order to leverage the WiX QtExec custom action to suppress the   -->
    <!-- pop-up UI that would ordinarily appear when running RegisterMceApp.exe. Registering a Windows   -->
    <!-- Media Center application will fail if it is already registered, so this setup will first        -->
    <!-- unregister the application and then attempt to re-register it. This setup ignores the return    -->
    <!-- code from the unregistration custom action but checks the return code of the registration       -->
    <!-- action. If registration fails, setup will fail and roll back. These custom actions use the      -->
    <!-- REGISTERMCEAPP property that is defined below in order to find the exact location of the file   -->
    <!-- RegisterMceApp.exe on the system.                                                               -->
    <CustomAction Id="CA_RegisterMceApp_Unregister_Install_Cmd" Property="CA_RegisterMceApp_Unregister_Install" Value="&quot;[REGISTERMCEAPP]&quot; /u /allusers &quot;[#Registration.xml]&quot;"/>
    <CustomAction Id="CA_RegisterMceApp_Unregister_Uninstall_Cmd" Property="CA_RegisterMceApp_Unregister_Uninstall" Value="&quot;[REGISTERMCEAPP]&quot; /u /allusers &quot;[#Registration.xml]&quot;"/>
    <CustomAction Id="CA_RegisterMceApp_Register_Cmd" Property="CA_RegisterMceApp_Register" Value="&quot;[REGISTERMCEAPP]&quot; /allusers &quot;[#Registration.xml]&quot;"/>
    <CustomAction Id="CA_RegisterMceApp_Rollback_Cmd" Property="CA_RegisterMceApp_Rollback" Value="&quot;[REGISTERMCEAPP]&quot; /u /allusers &quot;[#Registration.xml]&quot;"/>

    <CustomAction Id="CA_RegisterMceApp_Unregister_Install" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Return="ignore" Impersonate="no"/>
    <CustomAction Id="CA_RegisterMceApp_Unregister_Uninstall" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Return="ignore" Impersonate="no"/>
    <CustomAction Id="CA_RegisterMceApp_Register" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="deferred" Return="check" Impersonate="no"/>
    <CustomAction Id="CA_RegisterMceApp_Rollback" BinaryKey="WixCA" DllEntry="CAQuietExec" Execute="rollback" Return="ignore" Impersonate="no"/>

    <CustomAction Id="ActivateNetTcpPortSharing"
                  Directory="TARGETDIR"
                  ExeCommand="sc.exe config NetTcpPortSharing start= boot"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- The InstallExecuteSequence table describes the order that actions will be executed during       -->
    <!-- installation, repair and uninstall of this product.                                             -->
    <InstallExecuteSequence>
      <Custom Action="CA_BlockOlderVersionInstall" After="FindRelatedProducts">
        <![CDATA[NEWERVERSIONDETECTED]]>
      </Custom>
      <RemoveExistingProducts After="InstallInitialize" />
      <Custom Action="LaunchApplication" After="InstallFinalize"/>
      <LaunchConditions After="AppSearch"/>

      <!-- This custom action searches for Windows version 6.0, the Windows Media Center Ident registry  -->
      <!-- value 5.0 and the presence of the file %windir%\eHome\RegisterMceApp.exe. If all of these     -->
      <!-- conditions are met, the system is a Windows Vista Home Premium or Ultimate Edition operating  -->
      <!-- system and the product will be allowed to install.                                            -->
      <Custom Action="CA_ErrWrongWindowsVersion" Before="CostInitialize"><![CDATA[(NOT VersionNT >= 500) AND NOT Installed]]></Custom>

      <Custom Action="CA_RegisterMceApp_Unregister_Install_Cmd" After="CostFinalize">
        <![CDATA[NOT REMOVE]]>
      </Custom>
      <Custom Action="CA_RegisterMceApp_Unregister_Uninstall_Cmd" After="CA_RegisterMceApp_Unregister_Install_Cmd">
        <![CDATA[REMOVE AND ($Registration.xml = 2)]]>
      </Custom>
      <Custom Action="CA_RegisterMceApp_Register_Cmd" After="CA_RegisterMceApp_Unregister_Uninstall_Cmd">
        <![CDATA[NOT REMOVE]]>
      </Custom>
      <Custom Action="CA_RegisterMceApp_Rollback_Cmd" After="CA_RegisterMceApp_Register_Cmd">
        <![CDATA[NOT REMOVE]]>
      </Custom>

      <!-- This unregistration custom action must occur before files are removed during uninstall of the -->
      <!-- product because the custom action requires the registration XML file in order to run          -->
      <!-- correctly. It is conditioned to only run during uninstall using the REMOVE condition.         -->
      <Custom Action="CA_RegisterMceApp_Unregister_Uninstall" Before="RemoveFiles">
        <![CDATA[REMOVE AND ($Registration.xml = 2)]]>
      </Custom>

      <!-- This sequence of actions is important. In order to allow the roll back custom action to run   -->
      <!-- at the correct time in case the setup fails, it must be scheduled before the other actions    -->
      <!-- because Windows Installer pushes each action onto a stack and then pops them off of the stack -->
      <!-- in case of any failure in order to accomplish the roll back.                                  -->
      <Custom Action="CA_RegisterMceApp_Rollback" After="InstallFiles">
        <![CDATA[NOT REMOVE AND (&CLIENTFEATUREUI=3 OR !CLIENTFEATUREUI=3)]]>
      </Custom>
      <Custom Action="CA_RegisterMceApp_Unregister_Install" After="CA_RegisterMceApp_Rollback">
        <![CDATA[NOT REMOVE AND (&CLIENTFEATUREUI=3 OR !CLIENTFEATUREUI=3)]]>
      </Custom>
      <Custom Action="CA_RegisterMceApp_Register" After="CA_RegisterMceApp_Unregister_Install">
        <![CDATA[NOT REMOVE AND (&CLIENTFEATUREUI=3)]]>
      </Custom>
      <Custom Action="ActivateNetTcpPortSharing" Before="InstallFinalize">Not Installed</Custom>
      <!--<ScheduleReboot After="InstallFinalize"/>-->
    </InstallExecuteSequence>

    <!-- The InstallUISequence table describes the order that actions will be executed when the user     -->
    <!-- runs setup in full UI mode. Some actions must be scheduled in the UI and the execute sequence   -->
    <!-- tables to ensure that they will run regardless of whether the user runs setup in full UI mode   -->
    <!-- or in reduced UI or silent modes.                                                               -->
    <InstallUISequence>
      <Custom Action="CA_BlockOlderVersionInstall" After="FindRelatedProducts">
        <![CDATA[NEWERVERSIONDETECTED]]>
      </Custom>
      <Custom Action="CA_ErrWrongWindowsVersion" Before="CostInitialize"><![CDATA[(NOT VersionNT >= 500) AND NOT Installed]]></Custom>
    </InstallUISequence>

    <!-- This sets the icon used for the Add/Remove Programs screen -->
    <Property Id="ARPPRODUCTICON" Value="icon.ico" />

    <!-- These properties define links that will appear in the Add/Remove Programs control panel when    -->
    <!-- this product is installed on the system.                                                        -->
    <Property Id="ARPHELPLINK" Value="!(loc.Property_ArpHelpLink)" />
    <Property Id="ARPURLINFOABOUT" Value="!(loc.Property_ArpUrlInfoAbout)" />

    <!-- This property defines the ALLUSERS property to be 1, which indicates that this product will be  -->
    <!-- installed per-machine instead of per-user.                                                      -->
    <Property Id="ALLUSERS">
      <![CDATA[1]]>
    </Property>

    <!-- This property uses a registry locator to determine the version of Windows Media Center present  -->
    <!-- on the system (if any). This registry-based version detection algorithm is documented in the    -->
    <!-- Windows Media Center SDK for Windows Vista.                                                     -->
    <Property Id="MCEINSTALLVERSION" Secure="yes">
      <RegistrySearch Id="MceInstallRegKey" Root="HKLM" Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Media Center" Name="Ident" Type="raw"/>
    </Property>

    <!-- This property uses an AppSearch to attempt to locate the file %windir\eHome\ehShell.exe  on the -->
    <!-- system. If it is found, the property is set to the fully qualified path to this file, and this  -->
    <!-- path is used to create a desktop shortcut to launch the application in Windows Media Center.    -->
    <Property Id="EHSHELLEXE" Secure="yes">
      <DirectorySearch Id="EhomeDirectory" Path="[WindowsFolder]\ehome">
        <FileSearch Id="EhShellExe" Name="ehShell.exe" MinVersion="6.0.0.0" />
      </DirectorySearch>
    </Property>
    <!-- This property uses an AppSearch to attempt to locate the file %windir\eHome\RegisterMceApp.exe  -->
    <!-- on the system. If it is found, the property is set to the fully qualified path to this file,    -->
    <!-- and this path is used to call RegisterMceApp.exe in several custom actions listed above to      -->
    <!-- register this application with Windows Media Center.                                            -->
    <Property Id="REGISTERMCEAPP" Secure="yes">
      <DirectorySearch Id="EhomeDirectory2" Path="[WindowsFolder]\ehome">
        <FileSearch Id="RegisterMceAppExe" Name="RegisterMceApp.exe" />
      </DirectorySearch>
    </Property>

    <!-- This property is used as the default installation directory, and the user can change this path  -->
    <!-- during setup. The Id must be set to WIXUI_INSTALLDIR and the value must match the directory Id  -->
    <!-- defined above that represents the root installation directory.                                  -->
    <Property Id="WIXUI_INSTALLDIR" Value="APPLICATIONROOTDIRECTORY"/>

    <!-- In WiX v3.0, this variable is used to override the default license agreement text that is       -->
    <!-- included in the WixUIExtension with a custom file.                                              -->
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />

    <PropertyRef Id="NETFRAMEWORK35"/>

    <!-- OML Custom Managed Actions -->
    <CustomAction Id="ReserveTrailersUrlAction"
                  BinaryKey="OMLCALib"
                  DllEntry="ReserveTrailersUrl"
                  Execute="deferred"
                  Return="check" />

    <CustomAction Id="StartOMLEngineServiceAction"
                  BinaryKey="OMLCALib"
                  DllEntry="StartOMLEngineService"
                  Execute="deferred"
                  Return="check" />

    <Binary Id="OMLCALib"
            SourceFile="..\..\OMLCustomWiXAction\bin\$(var.BuildType)\OMLWiXActionsCAsPackage.dll" />

  </Fragment>
</Wix>

